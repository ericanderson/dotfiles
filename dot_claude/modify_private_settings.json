#!/bin/bash

# Read the existing content from stdin (provided by chezmoi)
existing_content=$(cat)

# If empty or not valid JSON, start with empty object
if [ -z "$existing_content" ] || ! echo "$existing_content" | jq . >/dev/null 2>&1; then
    existing_content="{}"
fi

# Our managed configuration
managed_config='{
  "$schema": "https://json.schemastore.org/claude-code-settings.json",
  "statusLine": {
    "type": "command",
    "command": "bunx -y ccstatusline@latest",
    "padding": 0
  }
}'

# Use jq to merge, preserving existing keys not in managed_config
echo "$existing_content" | jq --argjson managed "$managed_config" '. * $managed'