#!/bin/bash
set -euo pipefail

# gwt-claude - Git worktree helper that creates a worktree and opens Claude Code
# Usage: gwt-claude <branch-name>
#
# Creates a worktree for the specified branch at {repo-root}.worktrees/{branch-name}
# and opens Claude Code in it (via tmux window if available, or directly).

# Show usage if no branch name provided
if [ $# -eq 0 ]; then
    echo "Usage: gwt-claude <branch-name>" >&2
    echo "" >&2
    echo "Creates a git worktree for the branch and opens Claude Code in it." >&2
    echo "Worktree location: {repo-root}.worktrees/{branch-name}" >&2
    exit 1
fi

BRANCH_NAME="$1"

# Get the repository root
if ! REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null); then
    echo "Error: Not in a git repository" >&2
    exit 1
fi

# Compute worktree path
WT_PATH="${REPO_ROOT}.worktrees/${BRANCH_NAME}"

# Check if worktree already exists
if [ -d "$WT_PATH" ]; then
    echo "Worktree already exists at: $WT_PATH" >&2
    echo "Proceeding to open Claude Code..." >&2
else
    # Create the worktree
    echo "Creating worktree at: $WT_PATH"
    if ! git worktree add -b "$BRANCH_NAME" "$WT_PATH"; then
        echo "Error: Failed to create worktree" >&2
        exit 1
    fi
fi

# Open Claude Code in the worktree
if [ -n "${TMUX:-}" ]; then
    # Inside tmux: create new window and run claude
    tmux new-window -n "claude-$BRANCH_NAME" -c "$WT_PATH" claude
else
    # Not in tmux: cd and exec claude
    cd "$WT_PATH"
    exec claude
fi
