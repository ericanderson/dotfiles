#!/bin/bash
# 1Password sudo askpass helper

# Define 1Password CLI path (same as in setup script)
OP_PATH="/mnt/c/Users/e/AppData/Local/Microsoft/WinGet/Packages/AgileBits.1Password.CLI_Microsoft.Winget.Source_8wekyb3d8bbwe/op.exe"

# Get current user and hostname
USER=$(whoami)
HOSTNAME=$(hostname)

# Construct the item name (adjust format as needed)
# Example: "sudo-eanderson-ostrich" (@ is not allowed in 1Password references)
ITEM_NAME="sudo-${USER}-${HOSTNAME}"
VAULT_NAME="Private"

# Try to get the sudo password from 1Password
PASSWORD=$("$OP_PATH" read "op://${VAULT_NAME}/${ITEM_NAME}/password" 2>/dev/null)
OP_EXIT_CODE=$?

# If op succeeded, output the password
if [ $OP_EXIT_CODE -eq 0 ] && [ -n "$PASSWORD" ]; then
    echo "$PASSWORD"
    exit 0
fi

# If we get here, 1Password lookup failed
# For security, we don't provide a fallback - the askpass helper
# should only work with 1Password
echo "Failed to retrieve password from 1Password for ${ITEM_NAME}" >&2
echo "Please ensure the item exists in vault '${VAULT_NAME}'" >&2
exit 1