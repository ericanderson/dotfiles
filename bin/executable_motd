#!/bin/bash

# Message of the Day (MOTD) script for displaying system and chezmoi status
# Displays recent update info and pending changes

show_motd() {
    local log_file="$HOME/Library/Logs/chezmoi-update.log"
    local status_file="$HOME/.config/chezmoi-status"
    
    # Header
    echo ""
    echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
    echo "‚îÇ Welcome back! Here's your system status:           ‚îÇ"
    echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
    echo ""
    
    # System info
    echo "üñ•Ô∏è  System: $(sw_vers -productName) $(sw_vers -productVersion)"
    echo "üìÖ Date: $(date '+%A, %B %d, %Y at %I:%M %p')"
    echo "‚ö° Uptime: $(uptime | awk '{print $3,$4}' | sed 's/,//')"
    echo ""
    
    # Chezmoi status
    echo "üìÅ Chezmoi Status:"
    if [[ -f "$log_file" ]]; then
        # Get today's abbreviated weekday name (e.g., Mon)
        local today_day=$(date '+%a')
        # Get yesterday's abbreviated weekday name
        local yesterday_day=$(date -v-1d '+%a')
        
        # Get the last few relevant log entries
        local last_run=$(grep -E "${today_day}|${yesterday_day}" "$log_file" | tail -1)
        local last_success=$(grep "completed successfully" "$log_file" | tail -1)
        local last_error=$(grep -E "failed|error|Error" "$log_file" | tail -1)
        
        if [[ -n "$last_run" ]]; then
            local run_date=$(echo "$last_run" | cut -d':' -f1-3)
            echo "   Last run: $run_date"
            
            if echo "$last_run" | grep -q "completed successfully"; then
                echo "   Status: ‚úÖ Success"
            elif echo "$last_run" | grep -q "No changes to apply"; then
                echo "   Status: ‚ú® Up to date"
            elif echo "$last_run" | grep -q "skipping update"; then
                echo "   Status: ‚è∏Ô∏è  Skipped (safe conditions not met)"
            elif echo "$last_run" | grep -q "failed"; then
                echo "   Status: ‚ùå Failed"
            else
                echo "   Status: ‚ÑπÔ∏è  In progress or unknown"
            fi
        else
            echo "   Status: üÜï No recent runs found"
        fi
        
        # Show if there are any pending changes
        if command -v chezmoi &> /dev/null; then
            local changes=$(chezmoi status 2>/dev/null | wc -l)
            if [[ $changes -gt 0 ]]; then
                echo "   Pending: ‚ö†Ô∏è  $changes file(s) have changes"
            fi
        fi
    else
        echo "   Status: ‚ö†Ô∏è Log file not found"
    fi
    
    # Quick actions
    echo ""
    echo "üîß Quick commands:"
    echo "   ‚Ä¢ chezmoi status    - Check for changes"
    echo "   ‚Ä¢ chezmoi diff      - See what's different"
    echo "   ‚Ä¢ tail -f $log_file"
    echo "                      - Watch update log"
    echo ""
}

# If this script is executed directly, show the MOTD
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    show_motd
fi